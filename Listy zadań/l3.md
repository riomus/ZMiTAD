Lista 3 - Testy normalności rozkładu
==========

**R**
--------

*  [Example](http://stats.stackexchange.com/questions/3136/how-to-perform-a-test-using-r-to-see-if-data-follows-normal-distribution)
*  [Manual Shapiro-Wilk](http://stat.ethz.ch/R-manual/R-devel/library/stats/html/shapiro.test.html)
*  [Manual Kolmogorov-Smirnov](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/ks.test.html)
*  [Manual QQ](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/qqnorm.html)



*Na podstawie materiałów z poprzednich lat*

Wiele testów parametrycznych wymaga, by dane pochodziły z rozkladu zbliżonego do
normalnego. Dlatego testy badające normalność rozkladów są tak istotne. W testach
tych zawsze przyjmuje się H0 - rozkład zmiennej jest normalny. Odrzucenie H0 jest
wiec równoznaczne z przyjęciem hipotezy, że rozkład zmiennej nie jest normalny. Brak
podstaw do odrzucenia nie oznacza przyjęcia hipotezy o normalności rozkładu. Musimy
to jeszcze sprawdzić - w tym celu sporządzane są wykresy prawdopodobieństwoprawdopodobieństwo.

Dla małych próbek wykonujemy dwa testy:

*  Test Kołmogorowa - Smirnowa (K-S) z poprawką Lilleforsa (K-S-L), która jest
obliczana, gdy nie znamy średniej lub odchylenia standardowego całej populacji.
*  Test Shapiro - Wilka (S-W) - najbardziej polecany, ale może dawać błędne wyniki
dla próbek większych niż 2 tys.

Należy podkreślić, iż ostatnimi czasy test S-W stał się preferowanym testem
normalności rozkładu prawdopodobieństwa ze względu na jego silną moc w porównaniu
do innych dostępnych testów. 

[Test Kolmogorova-Smirnova](https://en.wikipedia.org/wiki/Kolmogorov%E2%80%93Smirnov_test)
--------------------------------------------------------------------------------------------

Test K-S dla jednej próbki (K-S one-sample test) bazuje na maksymalnej różnicy
pomiędzy empiryczną dystrybuantą (ECDF) a hipotetyczną dystrybuantą (CDF). Jeżeli
statystyka D jest znacząca, wówczas hipoteza głosząca, że analizowany rozkład jest
normalny powinna zostać odrzucona.
W wielu programach wykorzystywane wartości prawdopodobieństwa bazują na tych
wyznaczonych przez Masseya (1951) - wartości te są prawidłowe w przypadku, gdy
wartość średnia oraz odchylenie standardowe rozkładu normalnego są znane aproiri i
nie są estymowane na podstawie zebranych danych.
Test K-S powstał w latach 30 XIX wieku. Pozwala on na realizację porównania
pojedynczego rozkładu f(x) częstości z teoretycznym rozkładem g(x), lub dwóch
zaobserwowanych rozkładów. W obu przypadkach realizacja testu wymaga
zdefiniowania dystrybuanty (CDF) F(x) jak i G(X) oraz wyznaczenia wielkości
największej różnicy pomiędzy tymi funkcjami. 

### Założenia

*  Próbki są losowe (lub obie grupy próbek są losowe i niezależne).
*  Przestrzeń wartości powinna mieć przynajmniej zdefiniowany porządek (ordinal scale), a najlepiej gdyby była ciągła.
*  Znane są dokładne wartości (nie są estymowane z danych) średnie oraz odchylenia standardowe populacji z jakiej pochodzą próbki. 

### Hipoteza

   H0: F(x) = G(x) (two-sided)

   H1: F(x) != G(x) dla przynajmniej jednej wartości x

### Test

Obliczana jest testowa statystyka:
D = sup[ F(x) - G(x) ]
Dla pojedynczej próby o rozmiarze n wartości D, Dk dla k=sqrt(n), dla zadanego
poziomu istotności α wartości statystyki dane są tabelami lub obliczane
programistycznie (np. z wykorzystaniem symulacji Monte Carlo).
Jedną z zalet testu K-S jest to, iż pozwala on na graficzną reprezentację danych, co
pozwala użytkownikowi na swoistą weryfikację poprawności testu ([przykład](http://stackoverflow.com/a/27234467)). 
Dla dużych zbiorów danych (N>40) ze względu na [CLT](https://en.wikipedia.org/wiki/Central_limit_theorem) (centralne twierdzenie
graniczne) t-test powinnien pozwalać na poprawne wyniki nawet w sytuacji aberacji od
rozkładu normalnego. Jednakże, w rzeczywistości rozkłady dalece nie-normalne mogą
spowodować, iż t-test będzie generował omylne wyniki - nawet dla dużych zbiorów
danych.

### Wykres dystrybuanty 

Dystrybuanta / Empiryczna dystrybuanta pozwala na graficzną reprezentację charakteru
rozproszoności zbioru danych. Przykładowo przyjmijmy zbiór controlB (posortowany od
wartości najmniejszej do największej) 

```R
   controlB=c(0.01, 0.10, 0.15, 0.17, 0.24, 0.34, 0.38, 0.42, 0.45, 0.46, 0.50, 0.70, 0.94, 0.95, 1.26, 1.37, 1.55, 1.75, 3.20, 6.98, 50.57,60)
```

1/23 danych leży poniżej 0.10, 2/23 danych leżą poniżej 0.15, itd. Dla przypomnienia dla dowolnej wartości x,
wartości dystrybuanty F(x) oznacza ułamek danych jakie są ściśle mniejsze od wartości
x. Przykładowo F(3) dla danych controlB jest równe 19/23. 

### *Uwaga*

Jest kilka sytuacji w których błędem jest pełna ufność w wyniki t-testu:

   1. W przypadku, gdy grupa kontrolna oraz poddana terapii nie różnią się wartością średnią, lecz różnią się w inny sposób, np:

      ```matlab
         controlA={0.22, -0.87, -2.39, -1.79, 0.37, -1.54, 1.28, -0.31, -0.74, 1.72, 0.38, -0.17, -0.62, -1.10, 0.30, 0.15, 2.30, 0.19, -0.50, -0.09}
         treatmentA={-5.13, -2.19, -2.43, -3.83, 0.50, -3.25, 4.32, 1.63, 5.18, -0.43, 7.11, 4.87, -3.10, -5.81, 3.76, 6.31, 2.58, 0.07, 5.76, 3.50}
      ```
      Oba zbiory danych są zbalansowane względem zera - zatem wartość średnia
      tych zbiorów oscyluje blisko zera. Jednakże widoczna jest znacząca wariancja w
      zbiorze w porównaniu do grupy kontrolnej (-6 - 6 do -2.5 - 2.5). Dane są różne
      jednakże t-test nie jest w stanie wychwycić różnicy 

   2. W przypadku, gdy grupy kontrolna oraz poddana terapii są małe (np. po 20
      elementów) i różnią się wartością średnią, jednakże gdy znacząco nienormalny
      rozkład maskuje różnice, np: 

      ```matlab
         controlB={1.26, 0.34, 0.70, 1.75, 50.57, 1.55, 0.08, 0.42, 0.50, 3.20, 0.15, 0.49, 0.95, 0.24, 1.37, 0.17, 6.98, 0.10, 0.94, 0.38}
         reatmentB= {2.37, 2.16, 14.82, 1.73, 41.04, 0.23, 1.32, 2.91, 39.41, 0.11, 27.44, 4.51, 0.51, 4.50, 0.18, 14.68, 4.66, 1.30, 2.06, 1.19}
      ```      
      Oba te zbiory danych zostały wygenerowane z rozkładu lognormalnego i różnią się znacząco wartością średnią. 

[Test Lillieforsa](https://en.wikipedia.org/wiki/Lilliefors_test)
------------------------------------------------------------------
W tescie K-S pojawia się dość restrykcyjne założenie, że znana jest dokładna wartość
średnia oraz odchylenie standardowe analizowanej populacji - nie są one estymowane
z danych. W przeciwnym przypadku wartości statystyki D wyznaczone przez Masseya
nie są prawdziwe. Jednakże często nie mamy takiej wiedzy i wykorzystywane wartości
średnie wyznaczana są na podstawie dostępnych danych wówczas test normalności
przyjmuje dość skomplikowaną warunkowaną hipotezę - jak prawdopodobne jest
osiągnięcie danej wartości statystyki D (lub większej), pod warunkiem, że wartość
średnia oraz odchylenie standardowe zostały wyznaczone z danych. W takim
przypadku należy wykorzystać tak zwane prawdopodobieństwa Lillieforsa (1967) -
wartości statystyki - w celu wyznaczenia czy różnica obliczona zgodnie z KS jest
statystycznie znacząca. Test ten jest tak naprawdę testem K-S z odpowiednią korekcją. 

### Założenia

   *  Próbki są losowe.
   *  Przestrzeń wartości powinna mieć przynajmniej zdefiniowany porządek (ordinal scale), a najlepiej gdyby była ciągła.
   *  Nieznane są dokładne wartości (są estymowane z danych) średnie oraz odchylenia standardowe populacji z jakiej pochodzą próbki.

### Hipoteza

   H0: F(x) = G(x) (two-sided)

   H1: F(x) != G(x) dla przynajmniej jednej wartości x

### Test

Dla próbki składającej się z n obserwacji obliczana jest testowa statystyka D:
D = sup[ F(x) - G(x) ]
,gdzie G(x) jest empiryczną dystrybuantą próby, zaś F(x) jest dystrybuantą rozkładu
normalnego o wartości średniej równej wartości średniej próby i wariancji równej
wariancji próby (nie obciążonej - z n-1 w mianowniku).
Jeżeli wartość statystyki D przekracza wartość krytyczną należy odrzucić hipotezę, iż
obserwacje pochodzą z rozkładu normalnego. Wartości krytyczne wyznacza się
stosując metode symulacji Monte Carlo dla próby około 3-30 elementów i realizowane
są automatycznie w nowoczesnym oprogramowaniu do analizy statystycznej.
Lillefors na bazie bogatego zbioru symulacji argumentował, iż test ten jest znaczącym
udoskonaleniem testu chi^2 dla próby o małej liczbie elementów (<30) oraz, iż ma
większą siłę niż test K-S. 

Matlab:
```Matlab
   [H,P,LSTAT,CV] = lillietest(all)    
```

R:
```R
   install.packages('nortest')
   library(nortest)
   lillie.test()
```

[Test Shapiro-Wilka](https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test)
---------------------------------------------------------------------
Test Shapiro-Wilka (W) (1968) wykorzystywany jest do testowania normalności
rozkładu. Jeżeli statystyka W jest znacząca, to wówczas należy odrzucić hipotezę, iż
analizowana próba pochodzi z rozkładu normalnego. Jest to preferowany test na
normalność rozkładu ze względu na jego moc w porównaniu z innymi alternatywnymi
testami. Niektóre programy statystyczne pozwalaja na stosowanie testu W dla dużych
danych (do 5000 obserwacji) przy wykorzystaniu rozszerzenia testu zaproponowanego
przez Roystona (1982). 
Test ten bazuje na spostrzerzeniu, iż analizując dopasowanie próbnego zbioru danych
do rozkładu normalnego (jego wykresu w q-q plot) jest podobne do zadania liniowej
regresji - linia diagonalna jest linią idealnego dopasowania, zaś wszystkie odchylenia od
niej są podobne do residuów w zadaniu regresji. I właśnie analizując skalę tych
odchyleń można określić jakość dopasowania.
Autorzy testu rekomendują jego wykorzystanie dla małych zbiorów danych (<20)

### Założenia
   
   * Próbki są losowe.
   * Przestrzeń wartości powinna mieć przynajmniej zdefiniowany porządek (ordinal scale), a najlepiej gdyby była ciągła.
   * Nieznane są dokładne wartości (są estymowane z danych) średnie oraz odchylenia standardowe populacji z jakiej pochodzą próbki. 

### Hipoteza

   H0: F(x) ~ N(x)

   H1: F(x) !~ N(x)

### Test
W teście wykorzystywana jest następująca statystyka:

![eq](https://latex.codecogs.com/gif.latex?W%20%3D%20%5Cfrac%7B%28%5Csum_%7Bi%3D1%7D%5E%7Bn%7D%20a_i*x_i%29%5E2%7D%7B%5Csum_%7Bi%3D1%7D%5En%28x_i-%5Cbar%7Bx%7D%29%5E2%7D)

gdzie yi to próbki, posortowane, oraz ai to stałe wymagające weryfikacji. Cała idea
testu W polega na spostrzerzeniu, iż jeżeli faktycznie dane pochodzą z rozkładu
normalnego o nieznanej wartości średniej µ oraz wariancji σ2, to wówczas powinniśmy
być w stanie odwzorować te dane za pomocą prostego równiania liniowego:

![eq](https://latex.codecogs.com/gif.latex?y_i%3D%5Cmu&plus;%5Csigma*x_i%2C%20i%3D1%2C2%2C%5Cdots%20n)

gdzie xi to uporządkowany zbiór zmiennych losowych o rozkładzie N(0,1). Następnie
metodą najmniejszych kwadratów możemy wyznaczyć nieznane współczynniki ai.
Wektor tych wartości możemy wyznaczyć poprzez: 

![eq](https://latex.codecogs.com/gif.latex?a%27%3D%5Cfrac%7Bm%27V%5E%7B-1%7D%7D%7B%5Csqrt%7Bm%27V%5E%7B-1%7DV%5E%7B-1%7Dm%7D%7D)

gdzie V jest macierzą co-wariancji elementów wektora x, zaś wektor m jest wektorem
wartości oczekiwanych elementów x. Statystyka W ma największą wartość równą 1, zaś najmniejszą wartość równą na 12/(n-
1) (stąd dla dużych wartości n>10, minimalna waetość jest w przybliżeniu równa kwadratowi najmniejszego współczynnika). Im większa wartość statystyki tym bliższe
jest dopasowanie do rozkładu normalnego - jednakże nie jest to wystarczające, gdyż
wysokie wartości mogą wynikać ze zbyt małych zbiorów danych, które w rzeczywistości
nie są normalne. Natomiast przy odpowiednio małym W należy odrzucić hipotezę
zerową. 

### Interpretacja

Hipotezę zerową - populacja charakteryzuje się rozkładem normalnym - należy odrzucć
jeżeli wartość p jest mniejsza niż wyznaczony poziomu istotności. Wówczas możemy
stwierdzić, iż dane nie są z rozkładu normalnego. W przypadku wartości p większych od
wybranego poziomu istotności nie możemy odrzucić hipotezy zerowej, że dane
pochodzą z rozkładu normalnego. Przykładowo dla poziomu istotności 0.05, otrzymana
z danych wartość p 0.32 nie powoduje odrzucenia hipotezy, że dane pochodzą z
rozkładu normalnego.

Matlab:

```matlab
   [H, pValue, W] = swtest(data, alpha, 0) 
``` 

R:

```r
   res = shapiro.test(data) 
``` 


Zadania
----------

1. Przygotuj wykres dystrybuanty danych z wektora *controlB* oraz *treatmentB*

   ```R
      treatmentB= c(2.3,2.37, 2.16, 14.82, 1.73, 41.04, 0.23, 1.32, 2.91, 3.01, 39.41, 0.11, 27.44, 4.51, 0.51, 4.50, 0.18, 14.68, 4.66, 1.30, 2.06, 1.19,1.20)
   ```

   1. Przygotuj wykres dystrybuanty dla obu zbiorów ze zwykłą oraz logarytmiczną osią X
   2. Przygotuj wykresy QQ dla obu próbek
   3. Dokonaj analizy (empirycznej) wykresów
   4. Przygotuj wizualizację dystrybuant na jednym wykresie (w dwóch wersjach, z logarytmiczną i zwykłą skalą osi X)
   5. Zaznacz statystykę D testu K-S
   6. Wykonaj test K-S
   

   **Środowisko:** R

2. Wykonaj zadanie 1 dla poniższych danych w środowisku Matlab

   ```Matlab
      controlA={0.22, -0.87, -2.39, -1.79, 0.37, -1.54, 1.28, -0.31, -0.74, 1.72, 0.38, -0.17, -0.62, -1.10, 0.30, 0.15, 2.30, 0.19, -0.50, -0.09}
      treatmentA={-5.13, -2.19, -2.43, -3.83, 0.50, -3.25, 4.32, 1.63, 5.18, -0.43, 7.11, 4.87, -3.10, -5.81, 3.76, 6.31, 2.58, 0.07, 5.76, 3.50}
   ```

   **Środowisko:** Matlab

3. Pobierz zbiór danych na temat [demografii](http://www.wroclaw.pl/open-data/index.php/zbiory-danych/21-demografia/113-zameldowanie) wrocławia z portalu [*open-data*](http://www.wroclaw.pl/open-data)
   
   1. Przygotuj histogram rozkładu wieku mieszkańców bez podziału na dzielnice
   2. Zaprezentuj wykres QQ
   3. Czy możesz wykonać test K-S
   4. Nawet jeżeli nie możesz wykorzystać testu K-S zrób to. :fire:


   **Środowisko:** Dowolne (Matlab, R, Python, Java, MIPS assembly ...)

4. Pobież zbiór danych na temat zajętości  [parkingów](http://www.wroclaw.pl/open-data/index.php/zbiory-danych/17-transport/124-zapelnienie-parkingow)
 z portalu [*open-data*](http://www.wroclaw.pl/open-data)

   1. Znajdź liczbę dostępnych miejsc na poszczególnych parkingach (maksymalną wynikającą z projektu parkingu)
   2. Wyznacz procentową zajętość parkingu
   3. Porównaj ze sobą 2 wybrane parkingi, porównaj wartości procentowe oraz zwykłe
   4. Czy jest to poprawna metoda porównywania takich danych?


   **Środowisko:** Dowolne (Matlab, R, Python, Java, MIPS assembly ...)

5. Pobież dane na temat biegów [IRON MAN](http://academictorrents.com/details/2269d7d1c77375aea732eea0905e370d4741575f) z portalu [academic torrents](http://academictorrents.com)
   
   1. Dokonaj analizy atrybutów (np. wieku) z wybranych plików CSV (np. w danych latach i pomiędzy nimi) poznanymi metodami 
      1. QQ plot
      2. K-S test
      3. Lillieforse test
      4. S-W test 


   **Środowisko:** Dowolne (Matlab, R, Python, Java, MIPS assembly ...)

